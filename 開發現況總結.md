「今天吃什麼？」App 開發現況總結
這是一份為了讓接手的開發者或 AI 協作者能快速理解專案而撰寫的文件。本文件將概述專案的核心需求、技術架構，以及從原型至今各階段的主要更新。

一、 專案核心需求 (Core Requirements)

互動式地圖探索: 讓使用者在真實地圖上，透過拖曳手把直觀地「畫」出一個圓形的美食探索半徑。

智慧美食分類: 自動抓取範圍內的所有餐廳，並透過後端 AI 進行智慧分類。

沉浸式探索流程: 無縫地瀏覽店家列表與地圖資訊，不應有頻繁的頁面跳轉來打斷体験。

充滿儀式感的決策工具: 提供「命運羅盤」等模式，幫助使用者做出最終決定。

各版本主要更新
===v1 & v2===
此階段的核心是將 App 從一個使用模擬數據的原型，進化為一個完整串接真實世界 API 的 Web App。包含了 Google Maps API 的真實數據獲取、Gemini API 的智慧分類、以及安全的金鑰管理。

===v3===
此階段的核心任務是提升程式碼品質與可維護性，並徹底解決開發環境的痛點。

前端架構重構: 將原有的 js/app.js 檔案全面模組化，拆分為 state.js, api.js, ui.js, handlers.js 等七個職責明確的 ES6 模組。

後端服務整合: Flask 伺服器同時擔任 API 後端與前端靜態檔案伺服器，解決了本地開發的 CORS 問題，實現 python app.py 一鍵啟動。

AI 功能增強: 優化 Prompt，讓 Gemini API 在回傳分類時能自動附加 Emoji，實現了動態圖示系統。

API 穩定性修復: 修正了 gmaps.place API 呼叫中 fields 參數的命名錯誤。

===v4===
此版本專注於大幅提升搜尋廣度與使用者體驗的精緻化，引入了複雜的狀態管理與 UI 互動。

後端：複合式搜尋策略 (Compound Search Strategy)

動機: 為了解決 Google Maps API places_nearby 的回傳筆數限制，避免遺漏店家。

執行: 在 app.py 中，將單一搜尋請求重構為一個多階段的複合式搜尋流程：

寬泛類型搜尋: 遍歷一個包含 ['restaurant', 'cafe', 'food'...] 的寬泛類型列表，並使用 next_page_token 處理分頁，獲取每個類型最多約 40 筆的基礎資料。

精準關鍵字搜尋: 遍歷一個包含 ['拉麵', '火鍋', '素食'...] 的精準關鍵字列表，執行 keyword 搜尋，以補全特定但可能未被歸類在寬泛類型中的店家。

結果去重: 所有搜尋結果利用其唯一的 place_id 存入一個字典中，自動完成高效去重。

成果: 在不犧牲過多效能的前提下，最大化地獲取了目標區域內的所有美食相關店家。

前端：整合式篩選面板與狀態管理 (Integrated Filter Panel & State Management)

動機: 提供使用者更強大的篩選能力，同時保持 App 原有的 UI/UX 風格。

UI/UX 實現:

在 index.html 中新增篩選按鈕與一個預設隱藏的篩選面板 (#filter-panel)。

使用 CSS 實現了流暢的滑入/滑出動畫、精緻的按鈕與開關樣式，以及關閉按鈕。

在 handlers.js 中新增邏輯，實現了點擊面板外部區域可自動關閉的直覺操作。

狀態管理:

在 state.js 中新增 filters 物件，集中管理「營業中」、「價位」、「評分」的狀態。

重構 handlers.js 與 ui.js，建立了一個核心函式 applyFiltersAndRender()。所有篩選操作或分類點擊，都會先更新 state，再統一呼叫此函式，根據最新的 state 從原始資料 (state.restaurantData) 中篩選出結果，並重新渲染地圖、分類列表與店家預覽，實現了數據與視圖的分離。

前端：UI/UX 佈局優化

多行滾動類別: 透過 CSS Grid (grid-auto-flow: column)，將分類列表改為兩行或三行的橫向滾動佈局，並在 ui.js 中加入動態判斷邏輯，當分類數量過多時自動切換為三行，完美解決了先前 UI 遮擋與單行滾動不便的問題。

錯誤修復: 修正了 v3 重構時遺漏導入 initRadiusMap 函式，導致探索圈地圖無法初始化的 Bug。

===v5===
此版本是基於使用者回饋進行的快速迭代與體驗優化，大幅簡化並強化了美食地圖頁面的核心互動。

後端架構升級與穩定性強化:

API 拆分: 為優化前端等待體驗，將原有的 /api/search 拆分為 /api/find_places 與 /api/categorize_places 兩個獨立端點。這使得前端可以分階段顯示載入進度（"正在搜尋..." -> "正在請 AI 分類..."），避免使用者因長時間等待而感到焦慮。

Flask Blueprint: 引入 Flask Blueprint 機制來組織所有 API 路由，將 API 邏輯 (/api/*) 與前端頁面服務 (/) 徹底分離，解決了先前因路由衝突導致的 405 Method Not Allowed 錯誤，使後端架構更穩健、更具擴充性。

前端互動核心重構：單擊聚焦 (Single-Click Focus):

簡化互動: 根據使用者回饋，移除了原先較為複雜的「雙擊聚焦」、「單擊隱藏/恢復」等邏輯。

整合體驗: 現在的核心互動統一為單擊。使用者可以單擊多個類別來將它們加入「聚焦列表」。

地圖：只會顯示被聚焦的類別店家。

下方列表：未被聚焦的類別會變為半透明。

預覽與高亮：最後一個被點擊的類別會觸發下方的店家預覽列表，並在地圖上高亮其所有店家標記。

取消：再次單擊已聚焦的類別即可將其移出列表。

狀態管理簡化: 前端 state.js 也同步簡化，使用 focusedCategories 和 activeCategory 兩個狀態清晰地管理所有互動。

UI/UX 精緻化:

重設按鈕: 在地圖頁標頭新增了一個「重設檢視」按鈕。此按鈕僅在使用篩選功能時出現，讓使用者可以方便地一鍵清除所有聚焦，返回初始的全覽地圖。

版面佈局優化: 重新組織了標頭的結構，將「重設」與「篩選」兩個操作按鈕群組化，使其與標題分離，版面配置更平衡、更具呼吸感。

===v6===
此版本專注於提升核心「探索體驗」的沉浸感、精準度與互動性，並修復了前一版本遺留的穩定性問題。

後端：精準距離驗證 (Strict Distance Validation)

動機: 為了解決 Google Maps API 回傳結果有時會略微超出指定半徑的問題。

實現: 在 app.py 中引入 geopy 函式庫。在 /api/find_places 端點中，於獲取所有店家詳細資料後，增加了一道伺服器端過濾程序。此程序會使用 Haversine 公式精準計算每家餐廳與使用者設定中心點的直線距離，並剔除任何超出半徑的店家，確保 100% 的準確性。

前端：沉浸式範圍重設 (Immersive Radius Reselection)

動機: 讓使用者在瀏覽美食地圖時能更流暢地調整搜尋範圍，避免中斷體驗跳轉回上一頁。

實現:

在美食地圖頁 (categories-page) 新增「調整範圍」按鈕。

點擊後進入「編輯模式」，會暫時隱藏下方的分類列表，並在地圖上疊加「探索圈編輯器」（包含可拖曳的圓心和半徑手把）。

使用者可直接在地圖上調整範圍，完成後點擊下方的「以此範圍重新搜尋」按鈕，觸發一次全新的 find_places 與 categorize_places 流程。

整個過程在同一頁面完成，無縫更新地圖與分類結果，大幅提升了操作的沉浸感。

前端：互動體驗升級與 Bug 修復

可拖曳的中心點: 探索圈編輯器功能升級，不僅可以拖曳邊緣手把調整半徑，也可以直接拖曳圓心標記來微調探索圈的位置。

狀態管理與穩定性修復:

大幅重構了 js/map.js，將探索圈編輯器的邏輯（L.layerGroup）完全模組化，使其能被不同頁面的地圖實例安全地呼叫和銷毀。

徹底解決了因狀態管理混亂，導致獲取地圖中心點時回傳 null 並造成後端 400 錯誤的嚴重 Bug。

修正了 index.html 中因外部資源（Leaflet.js）路徑格式錯誤導致地圖無法載入的初始問題。

===v7===
此版本是基於使用者回饋，針對美食地圖頁面進行的大規模 UI/UX 現代化重構。

UI/UX 核心重塑：引入 Floating Action Hub

動機: 為了解決原先介面按鈕擁擠、遮擋地圖視野的問題。

執行:

引入浮動操作中心 (Floating Action Hub): 將「調整範圍」、「重設檢視」、「篩選」等輔助功能整合至一個位於地圖右下角的浮動按鈕中。點擊後，選項會以流暢的動畫向上展開，在不犧牲功能的前提下，最大化地圖可視範圍。

動態層次感佈局: 當使用者點擊美食分類後，店家預覽清單會從下方滑出，並動態地將上方的標題與 Hub 向上推移。此設計創造了豐富的 UI 層次感，並確保所有控制項在任何狀態下都清晰可見、不會互相遮擋。

底部控制面板重構: 將頁面標題移回底部，與 Hub 並排，下方則是加高後的分類列表與主流程按鈕，形成一個佈局合理、功能集中的「控制面板區」。

功能增強與流程優化:

新增「查看候選」面板: 在 Floating Action Hub 中新增了「查看候選」功能，點擊後會彈出一個獨立的浮動視窗，清晰列出所有已加入轉盤的店家，並允許使用者直接在該視窗中快速移除選項。

流程再定義: 將底部的主按鈕從「查看候選清單」更名為更有趣的「隨便啦 !」，使其語意更清晰地指向最終的「命運羅盤」決策環節。

穩定性與細節修復:

解決循環依賴: 徹底修復了 js/map.js 與 js/ui.js 之間因互相導入而產生的循環依賴 (Circular Dependency) 問題，確保了模組的穩定載入。

CSS 動畫修復: 修正了 Floating Action Hub 在展開時，選項按鈕因 position: absolute 錯誤堆疊在一起的 CSS Bug，確保動畫如預期般向上展開。

版面細節優化: 根據使用者回饋，加高了美食分類區塊的高度，使其能更舒適地容納兩排選項，提升了瀏覽體驗。

===v8===
此版本是一次全面的使用者體驗優化迭代，專注於提升地圖互動的流暢度與直覺性，並重構了「調整範圍」模式的使用流程。

核心體驗優化:

高精準度定位: 啟用 enableHighAccuracy 選項，優先使用 GPS 進行定位，大幅提升初次定位的準確性。

地圖資訊增強: 為初始的「探索圈」頁面地圖加入路名圖層，方便使用者辨識地理位置。

智慧地圖聚焦: 重新設計了地圖的飛行動畫邏輯。無論是點擊美食類別還是下方的店家預覽，地圖都會自動平移，將目標 marker 精準地置於視野上半部的視覺中心，避免被底部 UI 遮擋。

流暢互動動畫:

將地圖標記 (marker) 的提示動畫從「跳動」改為更柔和的「呼吸/縮放」效果。

透過將 CSS 動畫應用於 marker 的子元素，徹底解決了動畫效果與 Leaflet 地圖縮放互相衝突，導致 marker 位置跑掉的渲染問題 (rendering bug)。

直覺操作修正:

修正了點擊美食類別後，預覽清單和地圖標記沒有在第一時間響應的邏輯錯誤。

將店家預覽清單的觸發方式由「滑鼠懸浮 (mouseover)」改為「點擊 (click)」，避免在快速滑動時造成畫面的頻繁閃爍，提升操作穩定性。

「調整範圍」模式重構:

介面重構: 全面重新設計了調整範圍模式的底部 UI。以一個寬大的「以此範圍重新搜尋」主按鈕，搭配一個小巧的「取消」次要按鈕，取代了原先佈局混亂的設計。並新增了不透明的提示文字區塊，徹底解決了 UI 元件互相遮擋的問題。

宏觀視野: 進入此模式時，地圖會自動縮放至剛好能完整顯示整個探索圈的視野，方便使用者進行調整。

全覽視角: 在此模式下，地圖會暫時忽略使用者已選的特定美食類別，顯示所有符合廣域篩選條件（如「目前營業中」）的店家，為使用者提供完整的地理分佈參考。

穩定性修復:

修正了因 JavaScript 模組 export/import 邏輯錯誤導致的 Uncaught TypeError，恢復了調整範圍功能的正常運作。
修正了 HTML 中因手誤導致的 SVG 圖示語法錯誤。

四、 未來開發方向 (Future Development)
(經本次重構後，架構更穩固，未來可專注於功能擴展)

數據持久化: 使用 localStorage 讓使用者的「候選清單」與「篩選偏好」在重新整理後依然存在。

性能優化: 當範圍內餐廳過多時，地圖上的標記點可能影響效能。可研究引入 Marker Clustering (標記點聚合) 技術。

PWA (Progressive Web App): 增加 Manifest 和 Service Worker，讓使用者可以將 Web App 「安裝」到手機主畫面上。